---
title: "Five lines of R"
subtitle: ""
summary: ""
authors: []
tags: []
categories: []
date: 2021-03-30T10:18:37Z
featured: false
draft: false
projects: []
mininote: true
output: 
  hugodown::md_document:
    fig_width: 6 
    fig_asp: 0.59
rmd_hash: 84d4eca9f6e40193

---

Somebody on Twitter asked me whether B.1.1.7 data from Florida was still compatible with a logistic increase.

It's amazing how simple this sort of thing is to look at with the Tidyverse and nicely formatted SGTF data from [Helix](https://github.com/myhelix/helix-covid19db).

<div class="highlight">

<pre class='chroma'><code class='language-r' data-lang='r'><span class='kr'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='o'>(</span><span class='nv'><a href='http://tidyverse.tidyverse.org'>tidyverse</a></span><span class='o'>)</span>
<span class='nv'>data</span> <span class='o'>=</span> <span class='nf'>read_csv</span><span class='o'>(</span><span class='nf'><a href='https://rdrr.io/r/base/connections.html'>url</a></span><span class='o'>(</span><span class='s'>"https://raw.githubusercontent.com/myhelix/helix-covid19db/master/counts_by_state.csv"</span><span class='o'>)</span><span class='o'>)</span>
<span class='nv'>state_selection</span> <span class='o'>=</span> <span class='o'>(</span><span class='nv'>data</span> <span class='o'>%&gt;%</span> <span class='nf'>group_by</span><span class='o'>(</span><span class='nv'>state</span><span class='o'>)</span> <span class='o'>%&gt;%</span> <span class='nf'>summarise</span><span class='o'>(</span>total<span class='o'>=</span><span class='nf'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='o'>(</span><span class='nv'>positive</span><span class='o'>)</span><span class='o'>)</span> <span class='o'>%&gt;%</span> <span class='nf'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='o'>(</span><span class='nv'>total</span><span class='o'>&gt;</span><span class='m'>5000</span><span class='o'>)</span><span class='o'>)</span><span class='o'>$</span><span class='nv'>state</span>
<span class='nv'>data</span> <span class='o'>=</span> <span class='nv'>data</span>  <span class='o'>%&gt;%</span> <span class='nf'>mutate</span><span class='o'>(</span>percent_sgtf<span class='o'>=</span><span class='nv'>all_SGTF</span><span class='o'>/</span><span class='nv'>positive</span><span class='o'>)</span> <span class='o'>%&gt;%</span> <span class='nf'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='o'>(</span><span class='nv'>state</span> <span class='o'>%in%</span> <span class='nv'>state_selection</span><span class='o'>)</span>
<span class='nf'>ggplot</span><span class='o'>(</span><span class='nv'>data</span>,<span class='nf'>aes</span><span class='o'>(</span>x<span class='o'>=</span><span class='nv'>collection_date</span>, y<span class='o'>=</span><span class='nv'>percent_sgtf</span><span class='o'>)</span><span class='o'>)</span><span class='o'>+</span><span class='nf'>geom_point</span><span class='o'>(</span><span class='o'>)</span><span class='o'>+</span> <span class='nf'>stat_smooth</span><span class='o'>(</span>method <span class='o'>=</span> <span class='s'>"glm"</span>, method.args <span class='o'>=</span> <span class='nf'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='o'>(</span>family <span class='o'>=</span> <span class='s'>"binomial"</span><span class='o'>)</span>, se <span class='o'>=</span> <span class='kc'>FALSE</span>,  fullrange<span class='o'>=</span><span class='kc'>TRUE</span><span class='o'>)</span> <span class='o'>+</span><span class='nf'><a href='https://rdrr.io/r/graphics/plot.window.html'>xlim</a></span><span class='o'>(</span><span class='nf'>lubridate</span><span class='nf'>::</span><span class='nf'><a href='http://lubridate.tidyverse.org/reference/ymd.html'>ymd</a></span><span class='o'>(</span><span class='s'>"2020-12-01"</span><span class='o'>)</span>,<span class='nf'>lubridate</span><span class='nf'>::</span><span class='nf'><a href='http://lubridate.tidyverse.org/reference/ymd.html'>ymd</a></span><span class='o'>(</span><span class='s'>"2021-04-30"</span><span class='o'>)</span><span class='o'>)</span><span class='o'>+</span><span class='nf'>labs</span><span class='o'>(</span>title<span class='o'>=</span><span class='s'>"US SGTF"</span>,x<span class='o'>=</span><span class='s'>"Date"</span>,y<span class='o'>=</span><span class='s'>"Percent SGTF"</span><span class='o'>)</span><span class='o'>+</span><span class='nf'>facet_wrap</span><span class='o'>(</span><span class='o'>~</span><span class='nv'>state</span><span class='o'>)</span><span class='o'>+</span><span class='nf'>theme_bw</span><span class='o'>(</span><span class='o'>)</span><span class='o'>+</span><span class='nf'>scale_y_continuous</span><span class='o'>(</span>label<span class='o'>=</span><span class='nf'>scales</span><span class='nf'>::</span><span class='nv'><a href='https://scales.r-lib.org/reference/label_percent.html'>percent</a></span><span class='o'>)</span>

</code></pre>
<img src="figs/unnamed-chunk-1-1.png" width="700px" style="display: block; margin: auto;" />

</div>

There are lots of ways one could improve this, bringing in genome data and modelling uncertainty, but it provides a quick look at what's happening.

<hr>

**Addendum**

Despite the title, I decided to extend this a bit. Let's first do as above but take rolling averages of SGTF across 7-day intervals:

<div class="highlight">

<pre class='chroma'><code class='language-r' data-lang='r'><span class='kr'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='o'>(</span><span class='nv'><a href='http://tidyverse.tidyverse.org'>tidyverse</a></span><span class='o'>)</span>
<span class='kr'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='o'>(</span><span class='nv'><a href='http://zoo.R-Forge.R-project.org/'>zoo</a></span><span class='o'>)</span>
<span class='nv'>data</span> <span class='o'>=</span> <span class='nf'>read_csv</span><span class='o'>(</span><span class='nf'><a href='https://rdrr.io/r/base/connections.html'>url</a></span><span class='o'>(</span><span class='s'>"https://raw.githubusercontent.com/myhelix/helix-covid19db/master/counts_by_state.csv"</span><span class='o'>)</span><span class='o'>)</span>
<span class='nv'>state_selection</span> <span class='o'>=</span> <span class='o'>(</span><span class='nv'>data</span> <span class='o'>%&gt;%</span> <span class='nf'>group_by</span><span class='o'>(</span><span class='nv'>state</span><span class='o'>)</span> <span class='o'>%&gt;%</span> <span class='nf'>summarise</span><span class='o'>(</span>total<span class='o'>=</span><span class='nf'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='o'>(</span><span class='nv'>positive</span><span class='o'>)</span><span class='o'>)</span> <span class='o'>%&gt;%</span> <span class='nf'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='o'>(</span><span class='nv'>total</span><span class='o'>&gt;</span><span class='m'>5000</span><span class='o'>)</span><span class='o'>)</span><span class='o'>$</span><span class='nv'>state</span>
<span class='nv'>data</span> <span class='o'>=</span> <span class='nv'>data</span>  <span class='o'>%&gt;%</span> <span class='nf'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='o'>(</span><span class='nv'>state</span> <span class='o'>%in%</span> <span class='nv'>state_selection</span><span class='o'>)</span> <span class='o'>%&gt;%</span> <span class='nf'>arrange</span><span class='o'>(</span><span class='nv'>collection_date</span><span class='o'>)</span> <span class='o'>%&gt;%</span> <span class='nf'>group_by</span><span class='o'>(</span><span class='nv'>state</span><span class='o'>)</span> <span class='o'>%&gt;%</span> <span class='nf'>mutate</span><span class='o'>(</span>all_SGTF <span class='o'>=</span> <span class='nf'><a href='https://rdrr.io/pkg/zoo/man/rollmean.html'>rollsum</a></span><span class='o'>(</span><span class='nv'>all_SGTF</span>,<span class='m'>7</span>,na.pad<span class='o'>=</span><span class='kc'>T</span><span class='o'>)</span>,  positive<span class='o'>=</span><span class='nf'><a href='https://rdrr.io/pkg/zoo/man/rollmean.html'>rollsum</a></span><span class='o'>(</span><span class='nv'>positive</span>,<span class='m'>7</span>,na.pad<span class='o'>=</span><span class='kc'>T</span><span class='o'>)</span>, percent_sgtf<span class='o'>=</span><span class='nv'>all_SGTF</span><span class='o'>/</span><span class='nv'>positive</span><span class='o'>)</span>

<span class='c'>#ggplot(data,aes(x=collection_date, y=percent_sgtf))+geom_point()+ stat_smooth(method = "glm", method.args = list(family = "binomial"), se = FALSE,  fullrange=TRUE) +xlim(lubridate::ymd("2020-12-01"),lubridate::ymd("2021-04-30"))+labs(x="Date",y="Percent SGTF")+facet_wrap(~state)+theme_bw()+scale_y_continuous(label=scales::percent)</span>
</code></pre>

</div>

And now bring in case data from the New York Times and split these cases by likely SGTF status.

<div class="highlight">

<pre class='chroma'><code class='language-r' data-lang='r'><span class='nv'>case_data</span> <span class='o'>=</span> <span class='nf'>read_csv</span><span class='o'>(</span><span class='nf'><a href='https://rdrr.io/r/base/connections.html'>url</a></span><span class='o'>(</span><span class='s'>"https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv"</span><span class='o'>)</span><span class='o'>)</span> <span class='o'>%&gt;%</span> <span class='nf'>rename</span><span class='o'>(</span>State<span class='o'>=</span><span class='nv'>state</span><span class='o'>)</span>

<span class='nv'>case_data</span><span class='o'>=</span> <span class='nv'>case_data</span> <span class='o'>%&gt;%</span> <span class='nf'>group_by</span><span class='o'>(</span><span class='nv'>State</span><span class='o'>)</span> <span class='o'>%&gt;%</span> <span class='nf'>arrange</span><span class='o'>(</span><span class='nv'>date</span><span class='o'>)</span> <span class='o'>%&gt;%</span> <span class='nf'>mutate</span><span class='o'>(</span>daily_cases<span class='o'>=</span><span class='nv'>cases</span><span class='o'>-</span><span class='nf'><a href='https://rdrr.io/r/stats/lag.html'>lag</a></span><span class='o'>(</span><span class='nv'>cases</span><span class='o'>)</span><span class='o'>)</span> <span class='o'>%&gt;%</span> <span class='nf'>mutate</span><span class='o'>(</span>smoothed_daily_cases<span class='o'>=</span><span class='nf'><a href='https://rdrr.io/pkg/zoo/man/rollmean.html'>rollmean</a></span><span class='o'>(</span><span class='nv'>daily_cases</span>,k<span class='o'>=</span><span class='m'>7</span>,na.pad<span class='o'>=</span><span class='kc'>T</span><span class='o'>)</span><span class='o'>)</span>
<span class='nv'>case_data</span> <span class='o'>=</span> <span class='nf'>read_csv</span><span class='o'>(</span><span class='nf'><a href='https://rdrr.io/r/base/connections.html'>url</a></span><span class='o'>(</span><span class='s'>"https://raw.githubusercontent.com/jasonong/List-of-US-States/master/states.csv"</span><span class='o'>)</span><span class='o'>)</span><span class='o'>%&gt;%</span> <span class='nf'>inner_join</span><span class='o'>(</span><span class='nv'>case_data</span><span class='o'>)</span> 
<span class='nv'>together</span> <span class='o'>=</span> <span class='nv'>data</span> <span class='o'>%&gt;%</span> <span class='nf'>inner_join</span><span class='o'>(</span><span class='nv'>case_data</span>,by <span class='o'>=</span> <span class='nf'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='o'>(</span><span class='s'>"collection_date"</span><span class='o'>=</span><span class='s'>"date"</span>,<span class='s'>"state"</span><span class='o'>=</span><span class='s'>"Abbreviation"</span><span class='o'>)</span><span class='o'>)</span> <span class='o'>%&gt;%</span> <span class='nf'>mutate</span><span class='o'>(</span>`SGTF cases` <span class='o'>=</span> <span class='nv'>percent_sgtf</span> <span class='o'>*</span> <span class='nv'>smoothed_daily_cases</span>, `non-SGTF cases` <span class='o'>=</span> <span class='o'>(</span><span class='m'>1</span><span class='o'>-</span><span class='nv'>percent_sgtf</span><span class='o'>)</span> <span class='o'>*</span> <span class='nv'>smoothed_daily_cases</span><span class='o'>)</span> <span class='o'>%&gt;%</span> <span class='nf'>select</span><span class='o'>(</span><span class='nv'>State</span>,<span class='nv'>collection_date</span>,<span class='nv'>`SGTF cases`</span>,<span class='nv'>`non-SGTF cases`</span><span class='o'>)</span>  <span class='o'>%&gt;%</span> <span class='nf'>pivot_longer</span><span class='o'>(</span><span class='nf'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='o'>(</span><span class='nv'>`SGTF cases`</span>,<span class='nv'>`non-SGTF cases`</span><span class='o'>)</span><span class='o'>)</span>
<span class='nf'>ggplot</span><span class='o'>(</span><span class='nv'>together</span> <span class='o'>%&gt;%</span> <span class='nf'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='o'>(</span><span class='nv'>value</span><span class='o'>&gt;</span><span class='m'>0</span><span class='o'>)</span>,<span class='nf'>aes</span><span class='o'>(</span>x<span class='o'>=</span><span class='nv'>collection_date</span>, y<span class='o'>=</span><span class='nv'>value</span>,color<span class='o'>=</span><span class='nv'>name</span><span class='o'>)</span><span class='o'>)</span><span class='o'>+</span><span class='nf'>geom_line</span><span class='o'>(</span><span class='o'>)</span><span class='o'>+</span><span class='nf'>labs</span><span class='o'>(</span>title<span class='o'>=</span><span class='s'>"US daily cases by SGTF status"</span>,x<span class='o'>=</span><span class='s'>"Date"</span>,y<span class='o'>=</span><span class='s'>"Daily cases"</span>,color<span class='o'>=</span><span class='s'>"Type"</span><span class='o'>)</span><span class='o'>+</span><span class='nf'>facet_wrap</span><span class='o'>(</span><span class='o'>~</span><span class='nv'>State</span><span class='o'>)</span><span class='o'>+</span><span class='nf'>theme_bw</span><span class='o'>(</span><span class='o'>)</span><span class='o'>+</span><span class='nf'><a href='https://rdrr.io/r/graphics/plot.window.html'>xlim</a></span><span class='o'>(</span><span class='nf'>lubridate</span><span class='nf'>::</span><span class='nf'><a href='http://lubridate.tidyverse.org/reference/ymd.html'>ymd</a></span><span class='o'>(</span><span class='s'>"2021-1-01"</span><span class='o'>)</span>,<span class='kc'>NA</span><span class='o'>)</span><span class='o'>+</span><span class='nf'>scale_y_log10</span><span class='o'>(</span><span class='o'>)</span><span class='o'>+</span><span class='nf'>scale_color_manual</span><span class='o'>(</span>values<span class='o'>=</span><span class='nf'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='o'>(</span><span class='s'>"blue"</span>,<span class='s'>"red"</span><span class='o'>)</span><span class='o'>)</span><span class='o'>+</span><span class='nf'>coord_cartesian</span><span class='o'>(</span>ylim<span class='o'>=</span><span class='nf'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='o'>(</span><span class='m'>10</span>,<span class='m'>10000</span><span class='o'>)</span><span class='o'>)</span>

</code></pre>
<img src="figs/unnamed-chunk-4-1.png" width="700px" style="display: block; margin: auto;" />

</div>

Note that in the graph above we are relying here on SGTF data from one company, Helix, and then assuming it is representative of all cases in a state. This may not be an accurate assumption, as [noted by Marm Kilpatrick](https://twitter.com/DiseaseEcology/status/1377004446639550468). Interpret with caution.

